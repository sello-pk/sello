name: Deploy Sello

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          timeout: 300s
          command_timeout: 30m
          script: |
           set -e
           trap 'echo "SSH disconnected but deploy completed"' EXIT

            echo "üì¶ Loading NVM..."
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

            echo "üü¢ Switching to Node 22..."
            nvm use 22 || nvm install 22

            echo "üìÇ Moving to project directory..."
            cd /var/www/sello

            echo "‚¨áÔ∏è Syncing with GitHub (Main Branch)..."
            git fetch origin
            git reset --hard origin/main

            echo "üßπ Cleaning old build and untracked files..."
            git clean -fd -e .env -e uploads -e client/node_modules -e server/node_modules -e client/dist

            echo "üõ†Ô∏è Installing Server Dependencies..."
            cd server
            npm ci --omit=dev

            echo "üå± Running Database Sync Scripts..."
            node scripts/initializeVehicleCategories.js || echo "‚ö†Ô∏è Warning: Category initialization script failed"
            node scripts/seedDynamicVehicleAttributes.js || echo "‚ö†Ô∏è Warning: Seeding attributes failed"

            echo "üõ†Ô∏è Building Client Application..."
            cd ../client
            npm ci
            npm run build

            # Ensure Vite output matches Nginx root
            if [ -d "build" ]; then
              rm -rf dist
              mv build dist
            fi

            echo "üîÑ Restarting Backend with PM2..."
            cd ../server
            pm2 reload ecosystem.config.cjs --env production --update-env || pm2 start ecosystem.config.cjs --env production
            pm2 save

            echo "‚ôªÔ∏è Reloading Nginx Configuration..."
            sudo systemctl reload nginx

            echo "‚úÖ Deployment Successful!"
