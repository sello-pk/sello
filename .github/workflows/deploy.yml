name: Deploy Sello

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          timeout: 300s
          command_timeout: 30m
          script: |
            set -e
            trap 'echo "SSH disconnected but deploy completed"' EXIT

            echo "ğŸ“¦ Loading NVM..."
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

            echo "ğŸŸ¢ Switching to Node 22..."
            nvm use 22 || nvm install 22

            echo "ğŸ“‚ Moving to project directory..."
            cd /var/www/sello

            echo "â¬‡ï¸ Syncing with GitHub (Main Branch)..."
            git fetch origin
            git reset --hard origin/main

            echo "ğŸ§¹ Cleaning old build and untracked files..."
            git clean -fd -e .env -e uploads -e client/node_modules -e server/node_modules -e client/dist

            echo "ğŸ› ï¸ Installing Server Dependencies..."
            cd server
            npm ci --omit=dev

            echo "ğŸŒ± Running Database Sync Scripts..."
            node scripts/initializeVehicleCategories.js || echo "âš ï¸ Category init skipped"
            node scripts/seedDynamicVehicleAttributes.js || echo "âš ï¸ Attribute seed skipped"

            echo "ğŸ› ï¸ Building Client Application..."
            cd ../client
            npm ci
            npm run build

            if [ -d "build" ]; then
              rm -rf dist
              mv build dist
            fi

            echo "ğŸ”„ Restarting Backend with PM2..."
            cd ../server
            pm2 restart sello-server || pm2 start server.js --name sello-server
            pm2 save

            echo "â™»ï¸ Reloading Nginx Configuration..."
            sudo systemctl reload nginx

            echo "âœ… Deployment Successful!"