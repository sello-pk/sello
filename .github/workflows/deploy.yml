name: Deploy Sello

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            set -e

            echo "üìÇ Go to project directory"
            cd /var/www/sello

            echo "‚¨áÔ∏è Sync repo with GitHub"
            git fetch origin
            git reset --hard origin/main
            git clean -fd

            echo "üõ†Ô∏è Install server dependencies"
            cd server
            npm ci --omit=dev

            echo "üõ†Ô∏è Build client"
            cd ../client
            npm ci
            npm run build

            echo "üîÑ Restart app with PM2"
            if command -v pm2 >/dev/null 2>&1; then
              pm2 restart sello
              pm2 save
            else
              echo "‚ö†Ô∏è PM2 not found"
            fi

            echo "‚úÖ Deployment finished"
